# ➕ Add Expense
@login_required(login_url="/authentication/login")
def add_expense(request: HttpRequest) -> HttpResponse:
    categories = Category.objects.all()
    if request.method == "POST":
        amount_str = request.POST.get("amount") or ""
        description = request.POST.get("description") or ""
        date_str = request.POST.get("expense_date") or ""   # ✅ match template field
        category_name = request.POST.get("category") or ""

        # Validate amount
        try:
            amount_value = Decimal(amount_str)
        except Exception:
            messages.error(request, "Invalid amount")
            return render(request, "expenses/add_expense.html", {"categories": categories})

        # Validate description
        if not description.strip():
            messages.error(request, "Description is required")
            return render(request, "expenses/add_expense.html", {"categories": categories})

        # Validate date
        try:
            expense_date = datetime.strptime(date_str, "%Y-%m-%d").date()
        except ValueError:
            messages.error(request, "Invalid date format")
            return render(request, "expenses/add_expense.html", {"categories": categories})

        # Validate category
        try:
            category_obj = Category.objects.get(name=category_name)
        except Category.DoesNotExist:
            messages.error(request, "Selected category does not exist")
            return render(request, "expenses/add_expense.html", {"categories": categories})

        # Save expense
        Expense.objects.create(
            owner=request.user,  # ✅ match model field
            amount=amount_value,
            description=description,
            expense_date=expense_date,
            category=category_obj,
        )

        messages.success(request, "Expense saved successfully")
        return redirect("expenses")

    return render(request, "expenses/add_expense.html", {"categories": categories})
